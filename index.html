<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanos Resource Calculator</title>
    <link rel="stylesheet" href="./style.css">
    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>

<body>

    <div class="container">
        <!-- Left Side: Inputs -->
        <div class="inputs-panel">
            <h1>Thanos Sizing Calculator<br>(◊î◊õ◊†◊°◊î MAAS)</h1>
            <span class="subtitle">Resource Planning & Capacity Sizing</span>

            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('manual')" id="btnManual">Manual Input</button>
                <!-- Removing Estimator Wizard mode as requested, keeping logic clean -->
                <!-- <button class="mode-btn" onclick="setMode('estimator')" id="btnEstimator">New Project (Wizard)</button> -->
            </div>

            <!-- Manual Inputs Only (Estimator hidden) -->
            <div id="estimatorInputs" style="display:none;"></div>

            <div class="input-group">
                <label for="activeSeries">Active Series</label>
                <input type="number" id="activeSeries" value="1000000" min="0" step="1000">
                <div class="helper-text" id="seriesHelpText">Unique Time Series (Pre-replication)</div>
            </div>

            <div class="input-group">
                <label for="interval">Scrape Interval (Sec)</label>
                <input type="number" id="interval" value="60" min="1">
            </div>

            <div class="input-group">
                <label for="qps">Query Load (QPS)</label>
                <input type="number" id="qps" value="10" min="0" step="1">
                <div class="helper-text">Average Queries Per Second</div>
            </div>

            <!-- Query Complexity Selector -->
            <div class="input-group">
                <label for="queryComplexity">Query Complexity</label>
                <select id="queryComplexity">
                    <option value="52428800">Light (Instant Queries) - 50MB</option>
                    <option value="268435456" selected>Medium (1h Range) - 250MB</option>
                    <option value="1610612736">Heavy (1d-3d Range) - 1.5GB</option>
                    <option value="3221225472">Extreme (30d+ / High Card) - 3GB</option>
                </select>
                <div class="helper-text">Impacts Querier & Store RAM significantly.</div>
            </div>

            <!-- NEW: Performance/QoS Toggle -->
            <div class="input-group">
                <label for="perfMode">Performance Goal (SLO)</label>
                <select id="perfMode" onchange="calculate()">
                    <option value="1.0">Cost Optimized (High Utilization ~80%)</option>
                    <option value="1.3" selected>Balanced (Standard Prod ~60%)</option>
                    <option value="2.0">Low Latency (High Performance ~30%)</option>
                </select>
                <div class="helper-text">Affects CPU overprovisioning ratio.</div>
            </div>

            <div class="retention-grid">
                <span class="retention-title">Retention Policies</span>
                <div>
                    <label style="font-size:0.8rem">Receiver (Hours)</label>
                    <input type="number" id="retLocalHours" value="6" min="2" style="padding:8px; font-size:0.9rem">
                </div>
                <div>
                    <label style="font-size:0.8rem">Raw (Days)</label>
                    <input type="number" id="retRawDays" value="14" min="1" style="padding:8px; font-size:0.9rem">
                </div>
                <div>
                    <label style="font-size:0.8rem">5m (Days)</label>
                    <input type="number" id="ret5mDays" value="90" min="0" style="padding:8px; font-size:0.9rem">
                </div>
                <div>
                    <label style="font-size:0.8rem">1h (Days)</label>
                    <input type="number" id="ret1hDays" value="365" min="0" style="padding:8px; font-size:0.9rem">
                </div>
            </div>
        </div>

        <!-- Right Side: Results -->
        <div class="results-panel">

            <div class="summary-card">
                <!-- NEW: Total Pods -->
                <div class="summary-item">
                    <span class="summary-label">Total Pods</span>
                    <span class="summary-value" id="totalPods">0</span>
                    <small style="color:#94a3b8; font-size:0.7rem; display:block;">(Thanos Only)</small>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total vCPU</span>
                    <span class="summary-value" id="totalCpu">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total RAM</span>
                    <span class="summary-value" id="totalRam">0 GB</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">PVC Storage</span>
                    <span class="summary-value" id="totalPvc">0 GB</span>
                    <small style="color:#94a3b8; font-size:0.7rem; display:block;">(Local Disks)</small>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Object Storage</span>
                    <span class="summary-value" id="totalS3">0 GB</span>
                    <small style="color:#94a3b8; font-size:0.7rem; display:block;">(S3 Total)</small>
                </div>
            </div>

            <div class="dps-card">
                <span class="dps-value" id="dpsResult">0</span>
                <span class="dps-label">Data Points Per Second (DPS)</span>
            </div>

            <div class="grid-results">

                <!-- 1. OTel Collector -->
                <div class="result-card card-otel">
                    <div class="card-title" style="color: var(--otel-color);">1. OTel Collector</div>
                    <div class="metric-row">
                        <div class="card-value" id="otelReplicas">1</div>
                        <div class="card-detail">Replicas</div>
                        <span class="formula-text">Form: Vertical Scaling</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="otelCpu">0 vCPU</div>
                        <div class="card-detail">CPU (Ingestion)</div>
                        <span class="formula-text">Form: ceil(DPS / 10,000) * Perf</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="otelRam">0 GB</div>
                        <div class="card-detail">RAM (Buffer)</div>
                        <span class="formula-text">Form: 512MB + (DPS/10k)GB</span>
                    </div>
                </div>

                <!-- 2a. Thanos Router -->
                <div class="result-card card-router">
                    <div class="card-title" style="color: var(--router-color);">2a. Receive Router (Hashring)</div>
                    <div class="metric-row">
                        <div class="card-value" id="routerReplicas">2 Replicas</div>
                        <div class="card-detail">Stateless Distributor</div>
                        <span class="formula-text">Form: ceil(DPS / 30,000)</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="routerCpu">2 vCPU</div>
                        <div class="card-detail">Total vCPU</div>
                        <span class="formula-text">Form: Replicas * 1 Core * Perf</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="routerRam">0 GB</div>
                        <div class="card-detail">Total RAM</div>
                        <span class="formula-text">Form: Replicas * 1GB</span>
                    </div>
                </div>

                <!-- 2b. Thanos Ingestor -->
                <div class="result-card card-receive">
                    <div class="card-title" style="color: var(--receive-color);">2b. Receive Ingestors (Store)</div>
                    <div class="metric-row">
                        <div class="card-value" id="ingestorShards">3 Pods</div>
                        <div class="card-detail">Shards (StatefulSet)</div>
                        <span class="formula-text">Auto-scale: Max 4M Series/Pod</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="thanosRam">0 GB</div>
                        <div class="card-detail">Total Cluster RAM</div>
                        <span class="formula-text">Form: (Series * 4KB) + (QPS Overhead)</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="thanosDisk">0 GB</div>
                        <div class="card-detail">Total PVC (All Shards)</div>
                        <span class="formula-text">Form: WAL + Local TSDB Blocks</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="thanosCpu">0 vCPU</div>
                        <div class="card-detail">Total Ingest+Query CPU</div>
                        <span class="formula-text">Form: Ingestion + Query Load * Perf</span>
                    </div>
                </div>

                <!-- 3. Thanos Compactor -->
                <div class="result-card card-compact">
                    <div class="card-title" style="color: var(--compact-color);">3. Thanos Compactor</div>
                    <div class="metric-row">
                        <div class="card-value" id="compactDisk">0 GB</div>
                        <div class="card-detail">Scratch Disk PVC</div>
                        <span class="formula-text">Safety: 3 * (Max 2w Block)</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="compactRam">0 GB</div>
                        <div class="card-detail">RAM (Burst)</div>
                        <span class="formula-text">Form: 2GB Base -> Scale up</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="compactCpu">1 vCPU</div>
                        <div class="card-detail">CPU</div>
                        <span class="formula-text">Form: 1 Core (Vertical)</span>
                    </div>
                </div>

                <!-- 4. Thanos Store -->
                <div class="result-card card-store">
                    <div class="card-title" style="color: var(--store-color);">4. Thanos Store</div>
                    <div class="metric-row">
                        <div class="card-value" id="storeReplicas">1 Replicas</div>
                        <div class="card-detail">Stateful Set</div>
                        <span class="formula-text">Form: Static 1 (For Now)</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="storeRam">0 GB</div>
                        <div class="card-detail">Total RAM (Index+Buff)</div>
                        <span class="formula-text">Form: (S3 * 0.2%) + (QPS * Complexity)</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="storeCpu">0 vCPU</div>
                        <div class="card-detail">Total CPU</div>
                        <span class="formula-text">Form: ((Series/1.5M) + (QPS/15)) * Perf</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="storePvc">0 GB</div>
                        <div class="card-detail">Total Index Cache (PVC)</div>
                        <span class="formula-text">Form: S3 Size * 10% (Cache)</span>
                    </div>

                    <!-- NEW: Partitioning Recommendation -->
                    <div id="storePartitionTip" class="store-partition-tip"
                        style="display:none; margin-top:15px; padding:12px; background:rgba(234, 179, 8, 0.1); border:1px solid rgba(234, 179, 8, 0.3); border-radius:6px;">
                        <div style="color:#fbbf24; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">‚ö†Ô∏è
                            Recommendation: Split Store Gateway</div>
                        <div style="font-size:0.85rem; color:#cbd5e1;">
                            Total RAM usage (>32GB) is high. consider <strong>Time Partitioning</strong>:
                            <ul style="margin:5px 0 0 15px; padding:0;">
                                <li>1. <strong>Recent Store:</strong> Helper for last 3 days (High Performance).</li>
                                <li>2. <strong>Historic Store:</strong> For older data (Cost Efficient).</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 5. Query Frontend -->
                <div class="result-card card-frontend">
                    <div class="card-title" style="color: var(--frontend-color);">5. Query Frontend</div>
                    <div class="metric-row">
                        <div class="card-value" id="frontendReplicas">1 Replicas</div>
                        <div class="card-detail">Stateless / Caching</div>
                        <span class="formula-text">Form: Base 1 + (QPS / 50)</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="frontendCpuVal">1 vCPU</div>
                        <div class="card-detail">Total vCPU</div>
                        <span class="formula-text">Form: (Replicas * 1 Core) * Perf</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="frontendRamVal">2 GB</div>
                        <div class="card-detail">Total RAM (Cache)</div>
                        <span class="formula-text">Form: Replicas * 2GB</span>
                    </div>
                </div>

                <!-- 6. Thanos Querier -->
                <div class="result-card card-query">
                    <div class="card-title" style="color: var(--query-color);">6. Thanos Querier</div>
                    <div class="metric-row">
                        <div class="card-value" id="querierReplicas">1 Replicas</div>
                        <div class="card-detail">Stateless Engine</div>
                        <span class="formula-text">Form: Base 1 + (QPS / 20)</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="querierCpuVal">2 vCPU</div>
                        <div class="card-detail">Total vCPU</div>
                        <span class="formula-text">Form: (Replicas * 2 Core) * Perf</span>
                    </div>
                    <div class="metric-row">
                        <div class="card-value" id="querierRamVal">4 GB</div>
                        <div class="card-detail">Total RAM (Fan-out)</div>
                        <span class="formula-text">Form: Replicas * Complexity</span>
                    </div>
                </div>

                <!-- 7. Storage -->
                <div class="result-card card-storage">
                    <div class="card-title" style="color: var(--storage-color);">7. Object Storage (S3)</div>
                    <div class="metric-row">
                        <div class="card-value" id="s3Storage">0 GB</div>
                        <div class="card-detail">Total Capacity (S3)</div>
                        <span class="formula-text">Form: Raw + 5m (x5) + 1h (x5)</span>
                    </div>
                    <div class="metric-row">
                        <div style="font-size:0.75rem; color:#94a3b8; display:flex; justify-content:space-between;">
                            <span>Raw: <span id="valRaw" style="color:white"></span></span>
                            <span>5m: <span id="val5m" style="color:white"></span></span>
                            <span>1h: <span id="val1h" style="color:white"></span></span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- NEW: Safety & Tuning Panel -->
            <div class="safety-panel">
                <div class="safety-title">üõ°Ô∏è Production Tuning & Safety Flags</div>
                <div style="margin-bottom:15px; font-size:0.85rem; color:#cbd5e1;">
                    Recommended <code>GOMEMLIMIT</code> is 90% of container memory limit.
                    Concurrency flags are dynamic based on load.
                </div>

                <div class="safety-grid">

                    <!-- Query Safety -->
                    <div class="safety-card">
                        <div class="safety-header" style="color:var(--query-color);">Thanos Query</div>
                        <div class="safety-row">
                            <span class="safety-label">GOMEMLIMIT (Recommended)</span>
                            <span class="safety-val" id="safeQueryMem">90% of Limit (0.9)</span>
                        </div>
                        <div class="safety-row">
                            <span class="safety-label">--query.max-concurrent</span>
                            <span class="safety-val" id="safeQueryConcurrent">20</span>
                        </div>
                        <div class="safety-row">
                            <span class="safety-label">--query.timeout</span>
                            <span class="safety-val">2m</span>
                        </div>
                    </div>

                    <!-- Store Safety -->
                    <div class="safety-card">
                        <div class="safety-header" style="color:var(--store-color);">Thanos Store</div>
                        <div class="safety-row">
                            <span class="safety-label">GOMEMLIMIT (Recommended)</span>
                            <span class="safety-val" id="safeStoreMem">90% of Limit (0.9)</span>
                        </div>
                        <div class="safety-row">
                            <span class="safety-label">--store.grpc.series-max-concurrency</span>
                            <span class="safety-val" id="safeStoreConcurrency">20</span>
                        </div>
                        <div class="safety-row">
                            <span class="safety-label">--store.grpc.series-sample-limit</span>
                            <span class="safety-val" id="safeStoreSampleLimit">5e6</span>
                        </div>
                    </div>

                    <!-- Receiver Safety -->
                    <div class="safety-card">
                        <div class="safety-header" style="color:var(--receive-color);">Thanos Receiver</div>
                        <div class="safety-row">
                            <span class="safety-label">GOMEMLIMIT (Recommended)</span>
                            <span class="safety-val" id="safeReceiveMem">90% of Limit (0.9)</span>
                        </div>
                        <div class="safety-row">
                            <span class="safety-label">--receive.remote-write.server-max-concurrency</span>
                            <span class="safety-val" id="safeReceiveConcurrency">50</span>
                        </div>
                        <div class="safety-row" style="border-top:1px solid #475569; padding-top:8px;">
                            <span class="safety-label" style="color:var(--store-color)">Store API Limit
                                (Protection)</span>
                        </div>
                        <div class="safety-row">
                            <span class="safety-label">--store.limits.request-samples</span>
                            <span class="safety-val" id="safeReceiveRequestLimit">2.0e7</span>
                        </div>
                        <!-- Note on Tenant Limits -->
                        <div class="safety-row" style="margin-top:10px; opacity:0.7;">
                            <span class="safety-label" style="text-transform:none;">* Note: Set series/sample limits in
                                tenant config file (hashring).</span>
                        </div>
                    </div>

                    <!-- Compactor Safety -->
                    <div class="safety-card">
                        <div class="safety-header" style="color:var(--compact-color);">Thanos Compactor</div>
                        <div class="safety-row">
                            <span class="safety-label">GOMEMLIMIT (Recommended)</span>
                            <span class="safety-val" id="safeCompactMem">90% of Limit (0.9)</span>
                        </div>
                        <div class="safety-row">
                            <span class="safety-label">--compact.concurrency</span>
                            <span class="safety-val">1</span>
                        </div>
                    </div>

                </div>
            </div>

            <div class="explanation-box">
                <span class="explanation-title">üìä Complete Formula Reference Guide</span>
                <div id="explanationText">
                    <div style="margin-bottom:10px; color:#cbd5e1;">
                        This table summarizes all variables, constants, and formulas used for sizing.
                        <br><strong>Perf Factor:</strong> Chosen at the top (1.0 = Cost, 2.0 = Low Latency).
                    </div>
                    <table class="guide-table">
                        <thead>
                            <tr>
                                <th>Component / Metric</th>
                                <th>Formula / Logic</th>
                                <th>Explanation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>DPS (Write Rate)</strong></td>
                                <td class="guide-formula">Series / Interval</td>
                                <td class="guide-note">Actual Data Points Per Second.</td>
                            </tr>
                            <tr>
                                <td><strong>Receive Shards</strong></td>
                                <td class="guide-formula">MAX( Series/4M , CPU_Needed/4 )</td>
                                <td class="guide-note">Pods needed to stay under 4M series (RAM) or 4 Cores load.</td>
                            </tr>
                            <tr>
                                <td><strong>Receive RAM</strong></td>
                                <td class="guide-formula">(Series * 4KB) + (QPS * Complexity)</td>
                                <td class="guide-note">
                                    4KB index per series + query buffer.
                                    <br><strong>Note:</strong> Complexity capped at 300MB for Receiver due to short
                                    retention.
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Querier RAM</strong></td>
                                <td class="guide-formula">Replicas * ComplexityFactor</td>
                                <td class="guide-note">Memory for fan-out and merging of heavy queries.</td>
                            </tr>
                            <tr>
                                <td><strong>Receive CPU</strong></td>
                                <td class="guide-formula">(DPS / 15,000) + (QPS / 5)</td>
                                <td class="guide-note">
                                    1. <strong>Ingestion:</strong> 1 Core handles ~15k DPS efficiently.<br>
                                    2. <strong>Query:</strong> Decompression of hot data is CPU intensive.
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Receive Disk (PVC)</strong></td>
                                <td class="guide-formula">WAL + (DPS * Time * 1.5B)</td>
                                <td class="guide-note">
                                    WAL + Compressed local blocks based on local retention.
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Store Gateway RAM</strong></td>
                                <td class="guide-formula">(S3 Bytes * 0.2%) + 1GB + (QPS * Complexity)</td>
                                <td class="guide-note">RAM for Index Header Cache + Query processing buffer.</td>
                            </tr>
                            <tr>
                                <td><strong>Compactor Disk</strong></td>
                                <td class="guide-formula">3 * (Max Block Size)</td>
                                <td class="guide-note">
                                    Needs space for: Sources + Result + Backup (tmp). <br>
                                    Max block is usually 2-weeks (Resolution 0).
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Safety: Store API Limit</strong></td>
                                <td class="guide-formula">Max(20M, ActiveSeries * 20)</td>
                                <td class="guide-note">Protection against massive scans. Scaled by cluster size.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="./main.js"></script>

</body>

</html>